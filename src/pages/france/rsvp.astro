---
import WireframeLayout from '../../layouts/WireframeLayout.astro';
import { getGuestParty, getGuestEvents, getLatestRSVP } from '../../lib/notion';

const guest = Astro.locals.guest ?? 'Guest';
const guestId = Astro.locals.guestId;

let party: Awaited<ReturnType<typeof getGuestParty>> = [];
let coreEvents: Awaited<ReturnType<typeof getGuestEvents>> = [];
let optionalEvents: Awaited<ReturnType<typeof getGuestEvents>> = [];
let existingRSVP: Awaited<ReturnType<typeof getLatestRSVP>> = null;
let loadError: string | null = null;

if (guestId) {
  try {
    party = await getGuestParty(guestId);
    const events = (await getGuestEvents(guestId)).filter((event) => event.wedding === 'france');
    coreEvents = events.filter((event) => event.type === 'Core');
    optionalEvents = events.filter((event) => event.type === 'Optional');
    existingRSVP = await getLatestRSVP(guestId, 'france');
  } catch (error) {
    console.error('Failed to load France RSVP data:', error);
    loadError = 'We could not load your RSVP details right now. Please refresh and try again.';
  }
}

const attendingNames = new Set(
  (existingRSVP?.guestsAttending ?? '')
    .split(',')
    .map((name) => name.trim())
    .filter(Boolean)
);
const selectedEventIds = new Set(existingRSVP?.eventsAttending ?? []);
const existingDetails = existingRSVP?.details ?? {};
const existingSubmittedAt = existingRSVP?.submittedAt
  ? new Date(existingRSVP.submittedAt).toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
    })
  : null;
---

<WireframeLayout title="France RSVP">
  <header>
    <nav class="main-nav">
      <a href="/" class="logo">Chez Sargaux</a>
      <a href="/france" class="back-link">&larr; Back to France</a>
    </nav>
  </header>

  <main>
    <h1>RSVP</h1>
    <p class="subtitle">France · May 28–30, 2027</p>

    <div class="deadline-banner">
      <p>Please respond by <strong>March 15, 2027</strong></p>
    </div>

    {!guestId ? (
      <div class="error-card" data-testid="notion-required">
        <h2>RSVP Unavailable</h2>
        <p>
          RSVP submissions require the Notion guest backend. Please log in again once that
          integration is enabled.
        </p>
      </div>
    ) : loadError ? (
      <div class="error-card" data-testid="rsvp-load-error">
        <h2>Unable to Load RSVP</h2>
        <p>{loadError}</p>
      </div>
    ) : (
      <>
        {existingRSVP && (
          <aside class="existing-rsvp-banner" data-testid="existing-rsvp-banner">
            <p>
              We already have your RSVP. Last saved <strong>{existingSubmittedAt}</strong>.
              You can update and submit again anytime.
            </p>
          </aside>
        )}

        <form class="rsvp-form" id="rsvp-form" data-event="france">
          <section class="form-section">
            <h2>Who's Coming?</h2>
            <p class="section-note">Toggle each guest's attendance and edit names if needed.</p>

            {party.map((partyGuest) => {
              const isAttending =
                attendingNames.size > 0 ? attendingNames.has(partyGuest.name) : !partyGuest.isPlusOne;

              return (
                <div class:list={["guest-row", partyGuest.isPlusOne && 'plus-one']} data-guest-row>
                  <label class="guest-toggle">
                    <input
                      type="checkbox"
                      class="guest-attending"
                      checked={isAttending}
                    />
                    <span class="toggle-slider"></span>
                  </label>
                  <div class="guest-info">
                    <input
                      type="text"
                      class="guest-name"
                      value={partyGuest.name}
                      data-plus-one={partyGuest.isPlusOne ? 'true' : 'false'}
                    />
                    <span class="guest-status">{isAttending ? 'Attending' : 'Not attending'}</span>
                  </div>
                </div>
              );
            })}
          </section>

          <section class="form-section">
            <h2>Core Events</h2>
            <p class="section-note">These events are part of your invitation.</p>
            {coreEvents.length === 0 ? (
              <p class="placeholder-note">No core events are assigned to this invitation yet.</p>
            ) : (
              <div class="event-list">
                {coreEvents.map((event) => (
                  <label class="event-checkbox is-core">
                    <input
                      type="checkbox"
                      class="event-attending"
                      data-event-id={event.id}
                      data-event-type="core"
                      checked={selectedEventIds.size > 0 ? selectedEventIds.has(event.id) : true}
                    />
                    <span class="checkbox-mark"></span>
                    <div class="event-details">
                      <strong>{event.name}</strong>
                      <span class="event-info">{[event.time, event.location].filter(Boolean).join(' · ') || 'Details to come'}</span>
                    </div>
                  </label>
                ))}
              </div>
            )}
          </section>

          <section class="form-section">
            <h2>Optional Events</h2>
            <p class="section-note">Choose any extra celebrations you'd like to attend.</p>

            {optionalEvents.length === 0 ? (
              <p class="placeholder-note" data-testid="no-optional-events">No optional events are assigned right now.</p>
            ) : (
              <div class="event-list">
                {optionalEvents.map((event) => (
                  <label class="event-checkbox optional-event">
                    <input
                      type="checkbox"
                      class="event-attending"
                      data-event-id={event.id}
                      data-event-type="optional"
                      checked={selectedEventIds.has(event.id)}
                    />
                    <span class="checkbox-mark"></span>
                    <div class="event-details">
                      <strong>{event.name}</strong>
                      <span class="event-info">{[event.time, event.location].filter(Boolean).join(' · ') || 'Details to come'}</span>
                    </div>
                  </label>
                ))}
              </div>
            )}
          </section>

          <section class="form-section">
            <h2>Dietary Needs & Allergens</h2>
            <p class="section-note">Share any allergies or dietary requirements.</p>
            <textarea
              name="allergens"
              class="text-input"
              placeholder="List allergens or dietary restrictions"
              rows="3"
            >{existingDetails.allergens ?? existingRSVP?.dietary ?? ''}</textarea>
          </section>

          <section class="form-section two-column">
            <div>
              <h2>Accommodation</h2>
              <p class="section-note">Request accommodation at Village De Sully.</p>
              <select name="accommodation" class="single-line-input">
                <option value="unsure" selected={existingDetails.accommodation === undefined || existingDetails.accommodation === 'unsure'}>Not sure yet</option>
                <option value="yes" selected={existingDetails.accommodation === 'yes'}>Yes, please include me</option>
                <option value="no" selected={existingDetails.accommodation === 'no'}>No, I do not need accommodation</option>
              </select>
            </div>

            <div>
              <h2>Transport Help</h2>
              <p class="section-note">Do you need help arranging transport?</p>
              <select name="transport" class="single-line-input">
                <option value="unsure" selected={existingDetails.transport === undefined || existingDetails.transport === 'unsure'}>Not sure yet</option>
                <option value="yes" selected={existingDetails.transport === 'yes'}>Yes, I need assistance</option>
                <option value="no" selected={existingDetails.transport === 'no'}>No, I will arrange my own</option>
              </select>
            </div>
          </section>

          <section class="form-section">
            <h2>Message for Us</h2>
            <textarea
              name="message"
              class="text-input"
              placeholder="Share your well wishes or anything else we should know"
              rows="4"
            >{existingRSVP?.message ?? ''}</textarea>
          </section>

          <div class="feedback" aria-live="polite">
            <p id="form-success" class="success-message" hidden>RSVP submitted successfully.</p>
            <p id="form-error" class="error-message" hidden>We could not submit your RSVP. Please try again.</p>
          </div>

          <button type="submit" class="submit-btn">{existingRSVP ? 'Update RSVP' : 'Submit RSVP'}</button>

          <p class="form-note">Signed in as <strong>{guest}</strong>. You can update your response anytime before the deadline.</p>
        </form>
      </>
    )}
  </main>

  <footer>
    <p>&copy; 2026 Sam Gross</p>
  </footer>
</WireframeLayout>

<style>
  header {
    border-bottom: 1px solid #e5e5e5;
  }

  .main-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  .logo {
    font-size: 1.25rem;
    font-weight: 300;
    letter-spacing: 0.05em;
    text-decoration: none;
    color: #1a1a1a;
  }

  .back-link {
    font-size: 0.875rem;
    color: #666;
    text-decoration: none;
  }

  main {
    flex: 1;
    padding: 3rem 2rem;
    max-width: 680px;
    margin: 0 auto;
  }

  h1 {
    font-size: 2.5rem;
    font-weight: 300;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .subtitle {
    color: #666;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .deadline-banner {
    background: #f9f9f9;
    border: 1px solid #e5e5e5;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    margin-bottom: 2rem;
  }

  .existing-rsvp-banner {
    background: #eef9ff;
    border: 1px solid #b7e2f8;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    color: #164b66;
  }

  .rsvp-form {
    display: flex;
    flex-direction: column;
  }

  .form-section {
    padding: 1.25rem 0;
    border-bottom: 1px solid #e5e5e5;
  }

  .form-section h2 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
  }

  .two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .section-note {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.9rem;
  }

  .guest-row {
    display: flex;
    align-items: center;
    gap: 0.9rem;
    padding: 0.8rem;
    border: 1px solid #e5e5e5;
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .guest-row.plus-one {
    border-style: dashed;
  }

  .guest-toggle {
    position: relative;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
  }

  .guest-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    inset: 0;
    background: #ccc;
    border-radius: 999px;
    transition: background 0.2s;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 3px;
    top: 3px;
    border-radius: 50%;
    background: white;
    transition: transform 0.2s;
  }

  .guest-toggle input:checked + .toggle-slider {
    background: #1a1a1a;
  }

  .guest-toggle input:checked + .toggle-slider::before {
    transform: translateX(20px);
  }

  .guest-info {
    display: flex;
    flex: 1;
    align-items: center;
    gap: 0.75rem;
  }

  .guest-name {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 0.4rem;
    padding: 0.5rem 0.6rem;
    font-size: 0.95rem;
  }

  .guest-status {
    font-size: 0.8rem;
    color: #666;
    min-width: 90px;
    text-align: right;
  }

  .event-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .event-checkbox {
    display: flex;
    align-items: start;
    gap: 0.65rem;
    padding: 0.85rem;
    border: 1px solid #e5e5e5;
    border-radius: 0.5rem;
    cursor: pointer;
  }

  .event-checkbox.is-core {
    background: #fafafa;
  }

  .checkbox-mark {
    width: 18px;
    height: 18px;
    border: 1px solid #bbb;
    border-radius: 4px;
    margin-top: 2px;
    flex-shrink: 0;
    position: relative;
  }

  .event-checkbox input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .event-checkbox input:checked + .checkbox-mark::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 1px;
    width: 5px;
    height: 10px;
    border: solid #1a1a1a;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .event-details strong {
    display: block;
    margin-bottom: 0.1rem;
  }

  .event-info {
    color: #666;
    font-size: 0.86rem;
  }

  .placeholder-note {
    color: #666;
    font-size: 0.9rem;
  }

  .single-line-input,
  .text-input {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 0.5rem;
    padding: 0.7rem 0.75rem;
    font-size: 0.95rem;
    font-family: inherit;
  }

  .feedback {
    margin-top: 1rem;
    min-height: 1.5rem;
  }

  .success-message {
    color: #166534;
    font-size: 0.9rem;
  }

  .error-message {
    color: #b91c1c;
    font-size: 0.9rem;
  }

  .submit-btn {
    margin-top: 0.75rem;
    padding: 0.95rem 1.2rem;
    border: none;
    border-radius: 0.5rem;
    background: #1a1a1a;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
  }

  .submit-btn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
  }

  .form-note {
    margin-top: 0.8rem;
    color: #666;
    font-size: 0.85rem;
    text-align: center;
  }

  .error-card {
    border: 1px solid #fecaca;
    background: #fff7f7;
    border-radius: 0.6rem;
    padding: 1rem;
    color: #7f1d1d;
  }

  footer {
    padding: 2rem;
    text-align: center;
    border-top: 1px solid #e5e5e5;
  }

  @media (max-width: 768px) {
    .main-nav {
      padding: 1rem;
    }

    main {
      padding: 2rem 1rem;
    }

    h1 {
      font-size: 2rem;
    }

    .guest-info {
      flex-direction: column;
      align-items: start;
    }

    .guest-status {
      min-width: 0;
      text-align: left;
    }

    .two-column {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline>
  const form = document.getElementById('rsvp-form');

  if (form) {
    const submitButton = form.querySelector('button[type="submit"]');
    const successMessage = document.getElementById('form-success');
    const errorMessage = document.getElementById('form-error');

    const updateGuestStatus = (row) => {
      const checkbox = row.querySelector('.guest-attending');
      const status = row.querySelector('.guest-status');
      if (status && checkbox) {
        status.textContent = checkbox.checked ? 'Attending' : 'Not attending';
      }
    };

    const guestRows = form.querySelectorAll('[data-guest-row]');
    guestRows.forEach((row) => {
      updateGuestStatus(row);
      row.querySelector('.guest-attending')?.addEventListener('change', () => updateGuestStatus(row));
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';
      }
      if (successMessage) successMessage.hidden = true;
      if (errorMessage) errorMessage.hidden = true;

      const anyAttending = Array.from(form.querySelectorAll('.guest-attending')).some((checkbox) => checkbox.checked);

      const guestsAttending = Array.from(form.querySelectorAll('[data-guest-row]')).map((row) => {
        const nameInput = row.querySelector('.guest-name');
        const checkbox = row.querySelector('.guest-attending');
        return {
          name: nameInput?.value?.trim() || 'Guest',
          attending: checkbox?.checked === true,
        };
      });

      const optionalEvents = Array.from(form.querySelectorAll('.event-attending[data-event-type="optional"]'));
      const coreEventIds = Array.from(form.querySelectorAll('.event-attending[data-event-type="core"]')).map((input) => input.dataset.eventId).filter(Boolean);
      const optionalEventIds = optionalEvents
        .filter((input) => input.checked)
        .map((input) => input.dataset.eventId)
        .filter(Boolean);

      const allergens = form.querySelector('textarea[name="allergens"]')?.value?.trim();

      const payload = {
        event: form.dataset.event,
        guestsAttending,
        eventsAttending: anyAttending ? [...coreEventIds, ...optionalEventIds] : [],
        dietary: allergens || undefined,
        message: form.querySelector('textarea[name="message"]')?.value?.trim() || undefined,
        details: {
          accommodation: form.querySelector('select[name="accommodation"]')?.value || undefined,
          allergens: allergens || undefined,
          transport: form.querySelector('select[name="transport"]')?.value || undefined,
        },
      };

      try {
        const response = await fetch('/api/rsvp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error('Request failed');
        }

        if (successMessage) successMessage.hidden = false;
      } catch (error) {
        if (errorMessage) errorMessage.hidden = false;
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Update RSVP';
        }
      }
    });
  }
</script>
